apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namePrefix: rhobs-

resources:
- example/admission-webhook/deployment.yaml
- example/admission-webhook/service-account.yaml

# NOTE: a service although automatically created by OLM for webhooks still
# requires admission-webhook/service as the port generated by OLM uses 443
# but assumes targetPort to be 443 as opposed to "https" port of webhook - 8443

- example/admission-webhook/service.yaml
- example/admission-webhook/pod-disruption-budget.yaml

# additional files required for webhook deployment that are absent in examples
- cluster-role.yaml
- cluster-role-binding.yaml
- alertmanager-config-validating-webhook.yaml
- prometheus-rule-validating-webhook.yaml

patches:
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: prometheus-operator-admission-webhook
      spec:
        template:
          spec:
            containers:
            - name: prometheus-operator-admission-webhook
              args:
              - --web.enable-tls=true
              - --web.cert-file=/tmp/k8s-webhook-server/serving-certs/tls.crt
              - --web.key-file=/tmp/k8s-webhook-server/serving-certs/tls.key

  # rely on tls-certificates injected by OLM instead of mounting empty files
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: prometheus-operator-admission-webhook
      spec:
        template:
          spec:
            volumes:
            - name: tls-certificates
              $patch: delete

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: prometheus-operator-admission-webhook
      spec:
        template:
          spec:
            containers:
            - name: prometheus-operator-admission-webhook
              volumeMounts:
              - name: tls-certificates
                $patch: delete
